<!DOCTYPE html><html lang="en"><head><link href="http://fonts.googleapis.com/css?family=PT+Sans:400,700|PT+Serif:400,700" rel="stylesheet" type="text/css"><!-- Meta--><meta charset="utf-8"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>JSF and OnLoad for JDK 1.4 | Brisk Bee</title><meta name="description" content="Casual rants on mobile development"><meta name="keywords" content="briskbee, haldbæk, peter haldbæk, peter haldbaek, iphone, ios, android, findantenna, dvb-t, java, mobile, development"><meta name="author" content="Peter Haldbæk"><meta name="generator" content="DocPad v6.78.6" /><meta name="viewport" content="width=device-width"><!-- Icons--><link rel="shortcut icon" href="/ico/favicon.ico"><link rel="apple-touch-icon-precomposed" sizes="144x144" href="/ico/apple-touch-icon-144-precomposed.png"><link rel="apple-touch-icon-precomposed" sizes="114x114" href="/ico/apple-touch-icon-114-precomposed.png"><link rel="apple-touch-icon-precomposed" sizes="72x72" href="/ico/apple-touch-icon-72-precomposed.png"><link rel="apple-touch-icon-precomposed" href="/ico/apple-touch-icon-57-precomposed.png"><!--if lt IE 9script(async src="http://html5shim.googlecode.com/svn/trunk/html5.js")
--><!-- Styles--><link  rel="stylesheet" href="/vendor/prettify.css" /><link  rel="stylesheet" href="/vendor/bootstrap/css/bootstrap.min.css" /><link  rel="stylesheet" href="/styles/style.css" /></head><body><!-- Markup--><header><div class="container"><div class="row"><div class="col-md-2 visible-md visible-lg"></div><div class="col-md-8"><div class="background"><div class="top"><a href="/">Brisk Bee</a></div><nav class="topmenu"><ul class="list-inline"><li class="active"><a href="/">BLOG</a></li><li typeof="sioc:Page" about="/pages/about/"><a href="/pages/about/" property="dc:title">About</a></li></ul></nav></div></div><div class="col-md-2 visible-md visible-lg"></div></div></div></header><div class="container"><div class="row"><div class="col-md-2"></div><div class="col-md-8"><section id="content" class="content"><article id="post" class="post"><h1>JSF and OnLoad for JDK 1.4</h1><div class="pubdate">Published August 7th 2008</div><div class="post-content"><p>Calling a method in a bean when a JSF page is hit is often a needed requirement when doing JSF. This is however not something you get out of the box unfortunately and you need to look at solutions outside of the scope of the JSF specification. Frameworks like <a href="http://www.seamframework.org/">Seam</a> and <a href="http://shale.apache.org/">Shale</a> does address this but if you only need this functionality in one or two places it might seem a little overkill to include frameworks like these. Instead I discovered the <a href="http://jsf-comp.sourceforge.net/components/onload/index.html">JSF On-Load Action Listener</a> from jsf-comp which does excactly what I want.</p>
<p>If I use JDK 5 or later.</p>
<p>Which I don&#39;t.</p>
<p>I use 1.4 so I decided to take a quick glance at the code and realized it was not that tricky to convert into something my compiler liked. So here is the JDK 1.4 compatible version of the JSF On-Load Action Listener. Enjoy! :)</p>
<pre><code>/*
 * Copyright 2004 The Apache Software Foundation.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * 
 * --
 * 
 * $Log$
 * Revision 1.1  2005/11/07 04:23:26  arobinson74
 * Initial revision
 */
package net.sf.jsfcomp.ext.onload;

import java.io.InputStream;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;

import javax.faces.FacesException;
import javax.faces.context.FacesContext;
import javax.faces.el.MethodBinding;
import javax.faces.event.PhaseEvent;
import javax.faces.event.PhaseId;
import javax.faces.event.PhaseListener;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.dom4j.Document;
import org.dom4j.Element;
import org.dom4j.io.SAXReader;

/**
 * This class allows for actions to be run on the load of a JSF page. When a
 * page is requested or a page is being redirected to due to a result of JSF
 * navigation action result, this phase listener intercepts the call. Based on
 * the configuration of on load phase listener, actions can be invoked based on
 * the requested view ID.
 * &amp;lt;p&amp;gt;
 * The configuration of the phase listener is needed. Inside of the web.xml file
 * of the application, the onload-rules context property must be given. This
 * value should be a URL to where to find the XML file with the configuration
 * information.
 * &amp;lt;/p&amp;gt;
 * Example:
 * 
 * &amp;lt;pre&amp;gt;
 * &amp;amp;lt;context-param&amp;amp;gt;
 *  &amp;amp;lt;param-name&amp;amp;gt;onload-rules&amp;amp;lt;/param-name&amp;amp;gt;
 *  &amp;amp;lt;param-value&amp;amp;gt;/WEB-INF/onload-rules.xml&amp;amp;lt;/param-value&amp;amp;gt;
 * &amp;amp;lt;/context-param&amp;amp;gt;
 * &amp;lt;/pre&amp;gt;
 * 
 * &amp;lt;p&amp;gt;
 * The XML file must use the onload-rules.xsd schema. An example file and the
 * schema is included in the release.
 * &amp;lt;/p&amp;gt;
 * &amp;lt;p&amp;gt; 
 * The &#39;view-id&#39; element of the configuration has the same functionality of the
 * NavigationHandler behavior. The view ID value of the XML element must be
 * exactly the view ID or part of the view ID followed by the &#39;*&#39; character. To
 * match all views, use a &#39;*&#39; as the view-id element value
 * &amp;lt;/p&amp;gt;
 * 
 * @version $Revision: 649 $
 * @author $Author: arobinson74 $
 */
public class OnLoadPhaseListener implements PhaseListener {
  private final static long serialVersionUID = 1l;
  private static Log logger = LogFactory.getLog(OnLoadPhaseListener.class);
  private List rules; // contains objects of type NavigationRule

  /**
   * Default constructor
   */
  public OnLoadPhaseListener() {
    logger.info(&quot;OnLoadPhaseListener created&quot;);
  }

  /* (non-Javadoc)
   * @see javax.faces.event.PhaseListener#afterPhase(javax.faces.event.PhaseEvent)
   */
  public void afterPhase(PhaseEvent event) {
    // nothing to do here
  }

  /* (non-Javadoc)
   * @see javax.faces.event.PhaseListener#beforePhase(javax.faces.event.PhaseEvent)
   */
  public void beforePhase(PhaseEvent event) {
    processOnLoad(event.getFacesContext(), event.getFacesContext()
     .getViewRoot().getViewId());
  }

  /* (non-Javadoc)
   * @see javax.faces.event.PhaseListener#getPhaseId()
   */
  public PhaseId getPhaseId() {
    return PhaseId.RENDER_RESPONSE;
  }

  /**
   * Allows someone to extend this class and handle any events they want to
   * accomplish before the control is handed to the navigation handler. This
   * function is only invoked when the result of the on load action is not
   * null and is not equal to the success result
   * 
   * @param requestedViewId The original requested view ID
   * @param onLoadAction The action that was invoked on load
   * @param onLoadActionResult The on load actions result
   * @return true to let the control be passed to the navigation handler,
   *         false to abort the processing and let the current (requested)
   *         view be rendered
   */
  protected boolean beforeHandleNavigation(String requestedViewId,
    String onLoadAction, String onLoadActionResult) {
    return true;
  }

  private void processOnLoad(FacesContext ctx, String viewId) {
    NavigationRule rule;

    // ensure the settings have been loaded
    initialize();

    logger.debug(&quot;Processing on load of view &quot; + viewId);
    rule = getRule(viewId);
    if (rule == null) {
      logger.debug(&quot;No rule found for view &quot; + viewId);
      return;
    } else
      processRule(ctx, rule, viewId);
  }

  private NavigationRule getRule(String viewId) {
    logger.debug(&quot;Looking for rule for view &quot; + viewId);
    for (Iterator iter = rules.iterator(); iter.hasNext();) {
      NavigationRule rule = (NavigationRule) iter.next();
      String rViewId = rule.getViewId();

      // check for exact match
      logger.debug(&quot;Checking for exact match. Rule view: &quot; + rViewId);
      if (rViewId.equals(viewId)) {
        logger.info(&quot;Found rule with exact match&quot;);
        return rule;
      }

      // see if the rule ends with a wildcard
      if (rule.getViewId().endsWith(&quot;*&quot;) == false)
        continue;

      String ruleViewPrefix = rule.getViewId();
      ruleViewPrefix = ruleViewPrefix.substring(0, ruleViewPrefix
        .length() - 1);
      logger.debug(&quot;Checking if view starts with &quot; + ruleViewPrefix);

      if (viewId.startsWith(ruleViewPrefix) == false)
        continue;

      logger.debug(&quot;Found rule for viewId path &quot; + rule.getViewId());
      return rule;
    }

    return null;
  }

  private void processRule(FacesContext ctx, NavigationRule rule,
    String viewId) {
    MethodBinding method = ctx.getApplication().createMethodBinding(
      rule.getAction(), new Class[0]);

    if (method == null) {
      logger.warn(&quot;No method found for rule action &quot; + rule.getAction());
      return;
    }

    logger.debug(&quot;Invoking action: &quot; + rule.getAction());

    Object result = method.invoke(ctx, new Object[0]);

    if (result != null &amp;amp;&amp;amp; (result instanceof String)) {
      if (result.equals(rule.successResult) == false) {
        // allow sub classes to abort the navigation
        if (beforeHandleNavigation(viewId, rule.getAction(),
          (String) result) == false) {
          logger
            .info(&quot;Before handle navigation has aborted the on load &quot;
            + &quot;navigation&quot;);
          return;
        }
        logger.debug(&quot;Calling navigation handler with result: &quot;
          + result);

        // let the navigation handler implementation handle the rest of the load
        ctx.getApplication().getNavigationHandler().handleNavigation(
          ctx, rule.getAction(), (String) result);

        // shouldn&#39;t be necessary, but make sure the render response is called
        // if the request wasn&#39;t redirected
        if (!ctx.getResponseComplete())
          ctx.renderResponse();
      } else
        logger.debug(&quot;Result is equal to the success result. Result: &quot;
          + rule.successResult);
    } else {
      if (logger.isDebugEnabled())
        logger
         .debug(&quot;Result from rule is null or not a string. Result: &quot;
         + result);
    }
  }

  private void initialize() {
    if (this.rules != null)
      return;
    loadConfiguration();
  }

  private synchronized void loadConfiguration() {
    if (this.rules != null)
      return;
    this.rules = new ArrayList(); // contains objects of type NavigationRule
    FacesContext ctx = FacesContext.getCurrentInstance();
    String url = ctx.getExternalContext().getInitParameter(&quot;onload-config&quot;);

    try {
      if (url == null) {
        String msg = &quot;The external context did not have the &#39;onload-rules&#39; initialization &quot;
          + &quot;parameter. Please check your configuration.&quot;;
        logger.error(msg);
        throw new FacesException(msg);
      }

      logger.info(&quot;On Load configuration is being loaded from &quot; + url);
      InputStream configStream = FacesContext.getCurrentInstance()
        .getExternalContext().getResourceAsStream(url);

      // get the XML parsing structure
      Document xml = new SAXReader().read(configStream);
      Element root = xml.getRootElement();

      // pars out the rules
      List rules = root.elements(&quot;navigation-rule&quot;);
      logger.info(rules.size() + &quot; rule(s) have been found&quot;);

      for (Iterator iter = rules.iterator(); iter.hasNext();) {
        // for (Element rule : toGenericIterable(rules, Element.class))
        Element rule = (Element) iter.next();
        this.rules.add(new NavigationRule(rule
          .elementTextTrim(&quot;view-id&quot;), rule
          .elementTextTrim(&quot;action&quot;), rule
          .elementTextTrim(&quot;success-result&quot;)));
      }

      Collections.sort(this.rules);
      if (logger.isDebugEnabled()) {
        for (Iterator iter = rules.iterator(); iter.hasNext();) {
          // for (NavigationRule rule : this.rules)
          NavigationRule rule = (NavigationRule) iter.next();
          logger.debug(&quot;Rule: &quot; + rule);
        }
      }
    } catch (Exception ex) {
      logger.error(&quot;Failed to parse onload configuration&quot;, ex);
    }
  }

  private class NavigationRule implements Comparable {
    private String action;
    private String viewId;
    private String successResult;

    NavigationRule(String viewId, String action, String successResult) {
      this.viewId = viewId;
      this.action = action;
      this.successResult = successResult;
    }

    /**
     * @return Returns the successResult.
     */
    String getSuccessResult() {
      return this.successResult;
    }

    /**
     * @return Returns the action.
     */
    String getAction() {
      return this.action;
    }

    /**
     * @return Returns the fromViewId.
     */
    String getViewId() {
      return this.viewId;
    }

    public String toString() {
      return &quot;view-id: &quot; + viewId + &quot;, action: &quot; + action + &quot;, success-result: &quot; + successResult;
    }

    /* (non-Javadoc)
     * @see java.lang.Comparable#compareTo(T)
     */
    public int compareTo(Object o) {
      if (o instanceof NavigationRule) {
        NavigationRule rule = (NavigationRule) o;

        // sort longest to shortest
        return viewId.compareTo(rule.getViewId()) * -1;
      }

      return -1;
    }
  }
}

</code></pre></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'briskbee'; // required: replace example with your forum shortname
var disqus_identifier = 'jsf_and_onload_for_jdk_1_4';
var disqus_title = 'JSF and OnLoad for JDK 1.4';
var disqus_url = 'http://www.briskbee.com/posts/jsf_and_onload_for_jdk_1_4';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by<span class="logo-disqus">Disqus</span></a></article><section id="related"><h3>Related Posts</h3><nav class="linklist"><li><a href="/posts/eclipse_and_jboss_as_5_1_with_minimal_configuration/">Eclipse and JBoss AS 5.1 with minimal configuration</a> &nbsp;<span class="pubdate">June 25th 2010</span></li><li><a href="/posts/hibernate__oracle__hsqldb_and_sequences/">Hibernate, Oracle, HSQLDB and sequences</a> &nbsp;<span class="pubdate">September 22nd 2011</span></li><li><a href="/posts/changing_unnamed_constraints_in_play_/">Changing unnamed constraints in Play!</a> &nbsp;<span class="pubdate">August 11th 2012</span></li><li><a href="/posts/concrete_-_my_very_own_android_orm/">Concrete - My very own Android ORM</a> &nbsp;<span class="pubdate">October 28th 2010</span></li><li><a href="/posts/conferences/">Conferences</a> &nbsp;<span class="pubdate">January 16th 2010</span></li><li><a href="/posts/android_and_xml_parsers/">Android and XML parsers</a> &nbsp;<span class="pubdate">July 1st 2010</span></li><li><a href="/posts/cpu_spikes_on_jboss_as_5_1/">CPU spikes on JBoss AS 5.1</a> &nbsp;<span class="pubdate">June 29th 2010</span></li><li><a href="/posts/accessing_memory_database_in_play_/">Accessing memory database in Play!</a> &nbsp;<span class="pubdate">September 11th 2012</span></li><li><a href="/posts/minimal_jboss_as_5_1_configuration/">Minimal JBoss AS 5.1 configuration</a> &nbsp;<span class="pubdate">June 24th 2010</span></li><li><a href="/posts/mockito__static_imports_and_eclipse/">Mockito, static imports and Eclipse</a> &nbsp;<span class="pubdate">March 26th 2011</span></li><li><a href="/posts/options_for__rest_framework/">Options for  REST framework</a> &nbsp;<span class="pubdate">August 3rd 2010</span></li><li><a href="/posts/setting_up_a_datasource_in_jndi/">Setting up a datasource in JNDI</a> &nbsp;<span class="pubdate">July 26th 2010</span></li><li><a href="/posts/speeding_up_unit_tests_using_in-memory_database/">Speeding up unit tests using in-memory database</a> &nbsp;<span class="pubdate">September 27th 2010</span></li><li><a href="/posts/test_dependencies_in_maven/">Test dependencies in Maven</a> &nbsp;<span class="pubdate">August 26th 2010</span></li><li><a href="/posts/using_java_visualvm_with_jboss_as_5_1/">Using Java VisualVM with JBoss AS 5.1</a> &nbsp;<span class="pubdate">June 29th 2010</span></li></nav></section></section></div><div class="col-md-2"></div></div></div><footer><div class="container"><div class="row"><div class="col-md-2 visible-md visible-lg"></div><div class="col-md-8"><ui class="list-inline"><li><a href="/pages/about">About</a></li></ui><div class="pull-right">© Brisk Bee 2018</div></div><div class="col-md-2 visible-md visible-lg"></div></div></div></footer><!-- Scripts--><script defer="defer"  src="/vendor/prettify.js"></script><script defer="defer"  src="/vendor/jquery/jquery.min.js"></script><script defer="defer"  src="/vendor/bootstrap/js/bootstrap.min.js"></script><script defer="defer"  src="/vendor/log.js"></script><script defer="defer"  src="/vendor/modernizr.js"></script><script defer="defer"  src="/scripts/script.js"></script><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-18789185-3']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>