<!DOCTYPE html><html lang="en"><head><link href="http://fonts.googleapis.com/css?family=PT+Sans:400,700|PT+Serif:400,700" rel="stylesheet" type="text/css"><!-- Meta--><meta charset="utf-8"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Speeding up unit tests using in-memory database | Brisk Bee</title><meta name="description" content="Casual rants on mobile development"><meta name="keywords" content="briskbee, haldbæk, peter haldbæk, peter haldbaek, iphone, ios, android, findantenna, dvb-t, java, mobile, development"><meta name="author" content="Peter Haldbæk"><meta name="generator" content="DocPad v6.78.6" /><meta name="viewport" content="width=device-width"><!-- Icons--><link rel="shortcut icon" href="/ico/favicon.ico"><link rel="apple-touch-icon-precomposed" sizes="144x144" href="/ico/apple-touch-icon-144-precomposed.png"><link rel="apple-touch-icon-precomposed" sizes="114x114" href="/ico/apple-touch-icon-114-precomposed.png"><link rel="apple-touch-icon-precomposed" sizes="72x72" href="/ico/apple-touch-icon-72-precomposed.png"><link rel="apple-touch-icon-precomposed" href="/ico/apple-touch-icon-57-precomposed.png"><!--if lt IE 9script(async src="http://html5shim.googlecode.com/svn/trunk/html5.js")
--><!-- Styles--><link  rel="stylesheet" href="/vendor/prettify.css" /><link  rel="stylesheet" href="/vendor/bootstrap/css/bootstrap.min.css" /><link  rel="stylesheet" href="/styles/style.css" /></head><body><!-- Markup--><header><div class="container"><div class="row"><div class="col-md-2 visible-md visible-lg"></div><div class="col-md-8"><div class="background"><div class="top"><a href="/">Brisk Bee</a></div><nav class="topmenu"><ul class="list-inline"><li class="active"><a href="/">BLOG</a></li><li typeof="sioc:Page" about="/pages/about/"><a href="/pages/about/" property="dc:title">About</a></li></ul></nav></div></div><div class="col-md-2 visible-md visible-lg"></div></div></div></header><div class="container"><div class="row"><div class="col-md-2"></div><div class="col-md-8"><section id="content" class="content"><article id="post" class="post"><h1>Speeding up unit tests using in-memory database</h1><div class="pubdate">Published September 27th 2010</div><div class="post-content"><p>I am a big fan of test-driven principles but have been on projects where running the full unit test suite would last 2-3 hours simply because writing to and reading from the database would slow everything down. This normally lead to optimizations such as only creating test data once having the unfortunate side effect of making unit tests dependent on each other (one unit test may change some data used in another unit test). It can also lead to random behavior making the test pass one time and then not the other simply because unit tests are not necessarily run in the same sequence every time.</p>
<p>Using an in-memory database can improve time spent on running unit tests significantly. In this article I will discuss the pros and cons of this approach and show how to do this.</p>
<p>Before you start using in-memory databases for unit testing some basic questions should be asked.</p>
<ol>
<li>Does your database support in-memory use at all?
If it does there is no excuse for not using the in-memory database instead of the physical one. Databases I know of who currently support in-memory versions are <a href="http://www.sqlite.org/inmemorydb.html">SQLite</a>, <a href="http://hsqldb.org/">HSQLDB</a> and <a href="http://www.oracle.com/technetwork/database/timesten/overview/index.html">Oracle TimesTen</a>.</li>
<li>Do you use non ANSI SQL?</li>
<li>Do you use triggers?</li>
<li>Do you use some form of procedural SQL (PL/SQL and the likes)?</li>
</ol>
<p>If your database does not support in-memory usage and you can answer yes to one (or more) of the questions above it might turn out you cannot use in-memory databases but there are ways to solve this. Lets go into detail.</p>
<h2 id="do-you-use-non-ansi-sql-">Do you use non ANSI SQL?</h2>
<p>If your SQL is non ANSI SQL you will have a harder time switching between database vendors since the code now depends on vendor-specific SQL. One such example could be Oracles old definition of joins. In Oracle 8i and older versions outer left joins where defined like this</p>
<pre><code>SELECT * FROM emp, dept WHERE emp.deptno = dept.deptno(+)
</code></pre><p>Whereas the newer version (9i and onward) also supports the ANSI SQL definition</p>
<pre><code>SELECT * FROM emp LEFT OUTER JOIN dept on emp.deptno = dept.deptno
</code></pre><p>Please be aware that the old definition of left outer (and other) joins are still supported by Oracle meaning that the non ANSI SQL definition of joins still exist in a lot of places (I used to use them myself until I realized this).</p>
<p>If you use Hibernate this is (probably) not a problem since you can just change the database dialect of Hibernate when running your unit tests. But this requires that you do not make any direct use of (non ANSI) SQL and my experience is that this is seldom the case. There is always some special problem which is to hard to express via Hibernate and then you end up writing some SQL instead.</p>
<h2 id="do-you-use-triggers-">Do you use triggers?</h2>
<p>If you decide to use the in-memory database of HSQLDB (I did) and you have triggers in your (production) database you need to have something similar in your in-memory database. HSQLDB <a href="http://hsqldb.org/doc/2.0/guide/triggers-chapt.html">supports this</a> in its own peculiar way but it is actually quite neat in a testing environment because the trigger itself is a little piece of Java code that is executed. So you need to implement the triggers in the test database as well.</p>
<h2 id="do-you-use-some-form-of-procedural-sql-pl-sql-and-the-likes-">Do you use some form of procedural SQL (PL/SQL and the likes)?</h2>
<p>If your application makes heavy use of procedural SQL in-memory databases are probably not the best fit unless your production database supports this out of the box. Because you will probably have to rewrite all of your procedures to do so. If it is only a matter of converting one or two procedures an in-memory database like HSQLDB supports this like triggers above. It is just a matter of writing your procedure as some Java code and register it as a procedure in HSQLDB.</p>
<h2 id="using-an-in-memory-database">Using an in-memory database</h2>
<p>I was working on a project where unit testing was abandoned since running the tests were simply not possible. Not because it took a lot of time but simply because the tests would fail when they were being run together. Database connections were not released quickly enough giving all kinds of problems. So instead of trying to fix a problem I had been trying to solve for years I ended up redefining the whole testing framework making use of an in-memory database. We were using Oracle 10g and the database itself was pretty simple so it made a lot of sense to make the switch. Using HSQLDB in-memory is really easy. I implemented a base test class all unit tests extend from. This base test class is responsible for creating the proper JNDI context containing the HSQLDB data source.</p>
<pre><code>import javax.naming.InitialContext;
import org.hsqldb.jdbc.JDBCDataSource;

...

// Construct DataSource
JDBCDataSource ds = new JDBCDataSource();
ds.setDatabase(&quot;jdbc:hsqldb:mem:myDB&quot;);
ds.setUser(&quot;SA&quot;);
ds.setPassword(&quot;&quot;);

// Put datasource in JNDI context
InitialContext ic = new InitialContext();
ic.bind(&quot;java:/comp/env/jdbc/myDS&quot;, ds);
</code></pre><p>Before each test the database is created with schema, tables and test data. Since everything resides in memory initialization is exceptionally fast compared to a physical database. I never made any direct measurements to compare the two approaches but I know I never wait for a test to finish. It just does in an instant. That is such a relief!</p>
<p>The Hibernate configuration for the test classes must also be changed to use the HSQLDB dialect. Edit this in your hibernate.cfg.xml file:</p>
<pre><code>&lt;property name=&quot;dialect&quot;&gt;org.hibernate.dialect.HSQLDialect&lt;/property&gt;
</code></pre><p>Now you are set and you are ready to run your tests using an in-memory database.</p>
</div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'briskbee'; // required: replace example with your forum shortname
var disqus_identifier = 'speeding_up_unit_tests_using_in-memory_database';
var disqus_title = 'Speeding up unit tests using in-memory database';
var disqus_url = 'http://www.briskbee.com/posts/speeding_up_unit_tests_using_in-memory_database';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by<span class="logo-disqus">Disqus</span></a></article><section id="related"><h3>Related Posts</h3><nav class="linklist"><li><a href="/posts/android_and_xml_parsers/">Android and XML parsers</a> &nbsp;<span class="pubdate">July 1st 2010</span></li><li><a href="/posts/hibernate__oracle__hsqldb_and_sequences/">Hibernate, Oracle, HSQLDB and sequences</a> &nbsp;<span class="pubdate">September 22nd 2011</span></li><li><a href="/posts/changing_unnamed_constraints_in_play_/">Changing unnamed constraints in Play!</a> &nbsp;<span class="pubdate">August 11th 2012</span></li><li><a href="/posts/concrete_-_my_very_own_android_orm/">Concrete - My very own Android ORM</a> &nbsp;<span class="pubdate">October 28th 2010</span></li><li><a href="/posts/conferences/">Conferences</a> &nbsp;<span class="pubdate">January 16th 2010</span></li><li><a href="/posts/cpu_spikes_on_jboss_as_5_1/">CPU spikes on JBoss AS 5.1</a> &nbsp;<span class="pubdate">June 29th 2010</span></li><li><a href="/posts/eclipse_and_jboss_as_5_1_with_minimal_configuration/">Eclipse and JBoss AS 5.1 with minimal configuration</a> &nbsp;<span class="pubdate">June 25th 2010</span></li><li><a href="/posts/accessing_memory_database_in_play_/">Accessing memory database in Play!</a> &nbsp;<span class="pubdate">September 11th 2012</span></li><li><a href="/posts/jsf_and_onload_for_jdk_1_4/">JSF and OnLoad for JDK 1.4</a> &nbsp;<span class="pubdate">August 7th 2008</span></li><li><a href="/posts/minimal_jboss_as_5_1_configuration/">Minimal JBoss AS 5.1 configuration</a> &nbsp;<span class="pubdate">June 24th 2010</span></li><li><a href="/posts/mockito__static_imports_and_eclipse/">Mockito, static imports and Eclipse</a> &nbsp;<span class="pubdate">March 26th 2011</span></li><li><a href="/posts/options_for__rest_framework/">Options for  REST framework</a> &nbsp;<span class="pubdate">August 3rd 2010</span></li><li><a href="/posts/setting_up_a_datasource_in_jndi/">Setting up a datasource in JNDI</a> &nbsp;<span class="pubdate">July 26th 2010</span></li><li><a href="/posts/test_dependencies_in_maven/">Test dependencies in Maven</a> &nbsp;<span class="pubdate">August 26th 2010</span></li><li><a href="/posts/using_java_visualvm_with_jboss_as_5_1/">Using Java VisualVM with JBoss AS 5.1</a> &nbsp;<span class="pubdate">June 29th 2010</span></li></nav></section></section></div><div class="col-md-2"></div></div></div><footer><div class="container"><div class="row"><div class="col-md-2 visible-md visible-lg"></div><div class="col-md-8"><ui class="list-inline"><li><a href="/pages/about">About</a></li></ui><div class="pull-right">© Brisk Bee 2018</div></div><div class="col-md-2 visible-md visible-lg"></div></div></div></footer><!-- Scripts--><script defer="defer"  src="/vendor/prettify.js"></script><script defer="defer"  src="/vendor/jquery/jquery.min.js"></script><script defer="defer"  src="/vendor/bootstrap/js/bootstrap.min.js"></script><script defer="defer"  src="/vendor/log.js"></script><script defer="defer"  src="/vendor/modernizr.js"></script><script defer="defer"  src="/scripts/script.js"></script><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-18789185-3']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>